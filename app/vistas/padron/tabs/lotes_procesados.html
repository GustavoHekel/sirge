<div class="portlet box {CSS_GLOBAL} up-list-data">
	<div class="portlet-title">
		<div class="caption">
			<i class="icon-reorder"></i>Listado de lotes - {FUENTE_DATOS}
		</div>
	</div>
	<div class="portlet-body">
		<div class="container lote" style="width: 850px;"></div>
	</div>
</div>

<div style="display:none;">
	<div class="portlet box {CSS_GLOBAL} rechazo-list-data">
		<div class="portlet-body">
			<div id="div-rechazos" class="container" style="width: 1200px;">
				<table id="tabla_rechazos" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered"></table>
			</div>
		</div>
	</div>
	<div id="dialog-confirm"></div>
	<div id="dialog-respuesta"></div>
</div>

<script>
$(document).ready(function(){
	
	estilo_dialog ('{CSS_GLOBAL}');
	
	function armar_tabla () {
		
		$(".lote").empty();
		$(".lote").append('<table id="tabla_lotes" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered"></table>');
		
		$.ajax({
			
			type 		: 'post' ,
			url  		: 'funciones/metodos_ajax.php' ,
			data 		: {
				clase 		: 'Lotes' ,
				metodo 		: 'listadoLotes' ,
				p1			: '{ID_FUENTE_DATOS}'
			} ,
			dataType 	: 'json' ,
			success 	: function (data) {
				$("#tabla_lotes").empty();
				$('#tabla_lotes').dataTable({
					sDom		: 'rt<"bottom"flp><"clear">' ,
					bDestroy	: true ,
					aaData		: data['data'] ,
					aoColumns	: data['aoColumns']
				});
			}
			
		});
		
	}
	
	function detalle_lote (lote) {

		$.ajax({
			async		: false,
			type		: 'post',
			url			: 'funciones/metodos_ajax.php',
			data		: {
				clase	: 'Lotes',
				metodo	: 'detalleLotes',
				p1		: lote
			} ,
			success : function (data) {
				datos = data
			}
		});
		
		return datos;
		
	}
	
	armar_tabla ();
	
	
	$(".lote").on('click' , '#tabla_lotes .row-details' , function () {
		
		mostrar_loading ();

		if ($(this).hasClass('row-details-close')) {
	
			$(this).parents('tr').after(detalle_lote($(this).attr('lote')));
			$(this).parents('tr').next('tr').hide().fadeIn(500);
			$(this).removeClass('row-details-close').addClass('row-details-open')
			ocultar_loading () ;
			
		} else if ($(this).hasClass('row-details-open')){
			
			$(this).removeClass('row-details-open').addClass('row-details-close')
			$(this).parents('tr').next('tr').remove();
			ocultar_loading () ;
			
		}
	});
	
	$(".lote").on('click' , '#tabla_lotes .rechazos' , function () {
		
		mostrar_loading () ;
		var lote = $(this).attr('lote');
		
		$.ajax({
			type		: 'post',
			url			: 'funciones/metodos_ajax.php',
			dataType	: 'json',
			data		: {
				clase	: 'Lotes',
				metodo	: 'listadoRechazosLotes',
				p1		: lote,
				p2		: '{ID_FUENTE_DATOS}'
			},
			success 	: function (data) {
				$('#tabla_rechazos').dataTable({
					sDom		: 'rt<"bottom"flp><"clear">' ,
					bDestroy	: true ,
					aaData		: data['data'] ,
					aoColumns	: data['aoColumns']
				});

			}
		});
		
		$('#div-rechazos').dialog({
			title : 'Rechazos' ,
			width : 1100 ,
		});
		
		ocultar_loading () ;
		
	});
	
	$(".lote").on('click' , '.cerrar-lote' , function () {
		
		var lote 	= $(this).parent().attr('lote');
		var mensaje = "Est&aacute; por cerrar el lote <span style='font-weight: bold;'>" + lote + "</span>, est&aacute; seguro?";
		
		$("#dialog-confirm").html(mensaje);
		$("#dialog-confirm").dialog({
			
			title : "Cerrar lote?" ,
			buttons : [
			{
				text : "Aceptar" ,
				class : "btn green" , 
				click : function () {
					
					$(this).dialog("close");
					mostrar_loading ();
					
					$.ajax({
						
						type		: 'post',
						url			: 'funciones/metodos_ajax.php',
						data		: {
							clase		: 'Lotes',
							metodo		: 'cerrarLote',
							p1			: lote
						},
						success 	: function (data) {
							
							$("#dialog-respuesta").html(data);
							$("#dialog-respuesta").dialog({
								title : "Lote cerrado!" ,
								buttons : [
								{
									text : 'Ok' ,
									class : 'btn green' ,
									click : function() {
										$(this).dialog("close");
										armar_tabla ();
									}
								}]
							});
							
						},
						complete	: function () {
							ocultar_loading ();
						}
						
					});
				}
			} ,
			{
				text : "Cancelar" ,
				class: "btn red" ,
				click : function () {
					$(this).dialog("close");
				}
			
			}]
		})
		
	});
	
	$(".lote").on('click' , '#tabla_lotes .baja-lote' , function () {
		
		var lote 	= $(this).parent().attr('lote');
		var mensaje = "Est&aacute; por eliminar el lote <span style='font-weight: bold;'>" + lote + "</span>, est&aacute; seguro?";
		
		$("#dialog-confirm").html(mensaje);
		$("#dialog-confirm").dialog({
			title : "Eliminar lote?" ,
			buttons : [
			{
				text : "Aceptar" ,
				class : "btn green" ,
				click : function () {
					
					$(this).dialog("close");
					mostrar_loading ();
					
					$.ajax({
						
						type		: 'post',
						url			: 'funciones/metodos_ajax.php',
						data		: {
							clase		: 'Lotes',
							metodo		: 'bajaLotes',
							p1			: lote
						},
						success 	: function (data) {
							
							$("#dialog-respuesta").html(data);
							$("#dialog-respuesta").dialog({
								title : "Atenci√≥n!" ,
								buttons : [
								{
									text : 'Ok' ,
									class : 'btn green' ,
									click : function() {
										$(this).dialog("close");
										armar_tabla ();
									}
								}]
							});
							
						},
						complete	: function () {
							ocultar_loading ();
						}
						
					});
				}
			} ,
			{
				text : "Cancelar" ,
				class: "btn red" ,
				click : function () {
					$(this).dialog("close");
				}
			
			}]
		})
		
	});
	
});
</script>
